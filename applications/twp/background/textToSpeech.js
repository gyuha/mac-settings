"use strict";

const textToSpeech = function () {
  const textToSpeech = {};
  /**
   * @callback Callback_Speech_cbGetExtraParameters
   * @param {string} text
   * @param {string} targetLanguage
   * @return {string}
   */

  class Service {
    /**
     *
     * @param {string} serviceName
     * @param {string} baseURL
     * @param {string} xhrMethod
     * @param {Callback_Speech_cbGetExtraParameters} cbGetExtraParameters
     */
    constructor(serviceName, baseURL, xhrMethod, cbGetExtraParameters) {
      this.serviceName = serviceName;
      this.baseURL = baseURL;
      this.xhrMethod = xhrMethod;
      this.cbGetExtraParameters = cbGetExtraParameters;
      /** @type {Map<string, HTMLAudioElement>} */

      this.audios = new Map();
      this.audioSpeed = 1.0;
    }
    /**
     *
     * @param {string} fullText
     * @returns {string[]}
     */


    getRequests(fullText) {
      /** @type {string[]} */
      const fullTextSplitted = [];
      fullText.trim().split(" ").forEach(word => {
        if (word.length > 160) {
          while (word.length > 160) {
            fullTextSplitted.push(word.slice(0, 160));
            word = word.slice(160);
          }

          if (word.trim().length > 0) {
            fullTextSplitted.push(word);
          }
        } else if (word.trim().length > 0) {
          fullTextSplitted.push(word);
        }
      });
      /** @type {string[]} */

      const requests = [];
      let requestString = "";

      for (let text of fullTextSplitted) {
        text += " ";

        if (requestString.length + text.length < 170) {
          requestString += text;
        } else {
          requests.push(requestString);
          requestString = text;
        }
      }

      if (requestString.trim().length > 0) {
        requests.push(requestString);
        requestString = "";
      }

      return requests;
    }
    /**
     *
     * @param {string} text
     * @param {string} targetLanguage
     * @returns {Promise<any>}
     */


    async makeRequest(text, targetLanguage) {
      return await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();

        xhr.onload = e => {
          const reader = new FileReader();

          reader.onloadend = () => resolve(reader.result);

          reader.onerror = () => reject();

          reader.readAsDataURL(xhr.response);
        };

        xhr.onerror = e => {
          console.error(e);
          reject();
        };

        xhr.open(this.xhrMethod, this.baseURL + this.cbGetExtraParameters(text, targetLanguage));
        xhr.responseType = "blob";
        xhr.send();
      });
    }
    /**
     *
     * @param {string} fullText
     * @param {string} targetLanguage
     * @returns {Promise<void>}
     */


    async textToSpeech(fullText, targetLanguage) {
      const requests = this.getRequests(fullText);
      const promises = [];

      for (const requestText of requests) {
        const audioKey = [targetLanguage, requestText].join(", ");

        if (!this.audios.get(audioKey)) {
          promises.push(this.makeRequest(requestText, targetLanguage).then(
          /** @type {string} */
          response => {
            this.audios.set(audioKey, new Audio(response));
            return response;
          }).catch(e => {
            console.error(e);
            return null;
          }));
        }
      }

      await Promise.all(promises);
      return await this.play(requests.map(text => this.audios.get([targetLanguage, text].join(", "))));
    }
    /**
     * @param {HTMLAudioElement | HTMLAudioElement[]} audios
     */


    async play(audios) {
      this.stopAll();
      return await new Promise(resolve => {
        try {
          if (audios instanceof Array) {
            const playAll = (
            /** @type {number} */
            currentIndex) => {
              this.stopAll();
              const audio = audios[currentIndex];

              if (audio) {
                audio.playbackRate = this.audioSpeed;
                audio.play();

                audio.onended = () => {
                  playAll(currentIndex + 1);
                };
              } else {
                resolve();
              }
            };

            playAll(0);
          } else if (audios instanceof HTMLAudioElement) {
            audios.playbackRate = this.audioSpeed;
            audios.play();

            audios.onended = () => {
              resolve();
            };
          }
        } catch (e) {
          console.error(e);
          resolve();
        }
      });
    }
    /**
     *
     * @param {number} speed
     */


    setAudioSpeed(speed) {
      this.audioSpeed = speed;
      this.audios.forEach(audio => {
        audio.playbackRate = this.audioSpeed;
      });
    }

    stopAll() {
      this.audios.forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
      });
    }

  }

  const googleService = new Service("google", "https://translate.google.com/translate_tts?ie=UTF-8", "GET", function getExtraParameters(text, targetLanguage) {
    return `&tl=${targetLanguage}&client=dict-chrome-ex&ttsspeed=0.5&q=${encodeURIComponent(text)}`;
  });
  chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === "textToSpeech") {}
  });
  chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === "textToSpeech") {
      googleService.textToSpeech(request.text, request.targetLanguage).finally(() => {
        sendResponse();
      });
      return true;
    } else if (request.action === "stopAudio") {
      googleService.stopAll();
    }
  });
  twpConfig.onReady(async () => {
    twpConfig.onChanged((name, newvalue) => {
      if (name === "ttsSpeed") {
        googleService.setAudioSpeed(newvalue);
      }
    });
  });
  textToSpeech.google = googleService;
  return textToSpeech;
}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dFRvU3BlZWNoLmpzIiwibmFtZXMiOlsidGV4dFRvU3BlZWNoIiwiU2VydmljZSIsImNvbnN0cnVjdG9yIiwic2VydmljZU5hbWUiLCJiYXNlVVJMIiwieGhyTWV0aG9kIiwiY2JHZXRFeHRyYVBhcmFtZXRlcnMiLCJhdWRpb3MiLCJNYXAiLCJhdWRpb1NwZWVkIiwiZ2V0UmVxdWVzdHMiLCJmdWxsVGV4dCIsImZ1bGxUZXh0U3BsaXR0ZWQiLCJ0cmltIiwic3BsaXQiLCJmb3JFYWNoIiwid29yZCIsImxlbmd0aCIsInB1c2giLCJzbGljZSIsInJlcXVlc3RzIiwicmVxdWVzdFN0cmluZyIsInRleHQiLCJtYWtlUmVxdWVzdCIsInRhcmdldExhbmd1YWdlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ4aHIiLCJYTUxIdHRwUmVxdWVzdCIsIm9ubG9hZCIsImUiLCJyZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkZW5kIiwicmVzdWx0Iiwib25lcnJvciIsInJlYWRBc0RhdGFVUkwiLCJyZXNwb25zZSIsImNvbnNvbGUiLCJlcnJvciIsIm9wZW4iLCJyZXNwb25zZVR5cGUiLCJzZW5kIiwicHJvbWlzZXMiLCJyZXF1ZXN0VGV4dCIsImF1ZGlvS2V5Iiwiam9pbiIsImdldCIsInRoZW4iLCJzZXQiLCJBdWRpbyIsImNhdGNoIiwiYWxsIiwicGxheSIsIm1hcCIsInN0b3BBbGwiLCJBcnJheSIsInBsYXlBbGwiLCJjdXJyZW50SW5kZXgiLCJhdWRpbyIsInBsYXliYWNrUmF0ZSIsIm9uZW5kZWQiLCJIVE1MQXVkaW9FbGVtZW50Iiwic2V0QXVkaW9TcGVlZCIsInNwZWVkIiwicGF1c2UiLCJjdXJyZW50VGltZSIsImdvb2dsZVNlcnZpY2UiLCJnZXRFeHRyYVBhcmFtZXRlcnMiLCJlbmNvZGVVUklDb21wb25lbnQiLCJjaHJvbWUiLCJydW50aW1lIiwib25NZXNzYWdlIiwiYWRkTGlzdGVuZXIiLCJyZXF1ZXN0Iiwic2VuZGVyIiwic2VuZFJlc3BvbnNlIiwiYWN0aW9uIiwiZmluYWxseSIsInR3cENvbmZpZyIsIm9uUmVhZHkiLCJvbkNoYW5nZWQiLCJuYW1lIiwibmV3dmFsdWUiLCJnb29nbGUiXSwic291cmNlcyI6WyJ0ZXh0VG9TcGVlY2guanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG5jb25zdCB0ZXh0VG9TcGVlY2ggPSAoZnVuY3Rpb24gKCkge1xyXG4gIGNvbnN0IHRleHRUb1NwZWVjaCA9IHt9O1xyXG5cclxuICAvKipcclxuICAgKiBAY2FsbGJhY2sgQ2FsbGJhY2tfU3BlZWNoX2NiR2V0RXh0cmFQYXJhbWV0ZXJzXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHRleHRcclxuICAgKiBAcGFyYW0ge3N0cmluZ30gdGFyZ2V0TGFuZ3VhZ2VcclxuICAgKiBAcmV0dXJuIHtzdHJpbmd9XHJcbiAgICovXHJcbiAgY2xhc3MgU2VydmljZSB7XHJcbiAgICAvKipcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VydmljZU5hbWVcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlVVJMXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30geGhyTWV0aG9kXHJcbiAgICAgKiBAcGFyYW0ge0NhbGxiYWNrX1NwZWVjaF9jYkdldEV4dHJhUGFyYW1ldGVyc30gY2JHZXRFeHRyYVBhcmFtZXRlcnNcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmljZU5hbWUsIGJhc2VVUkwsIHhock1ldGhvZCwgY2JHZXRFeHRyYVBhcmFtZXRlcnMpIHtcclxuICAgICAgdGhpcy5zZXJ2aWNlTmFtZSA9IHNlcnZpY2VOYW1lO1xyXG4gICAgICB0aGlzLmJhc2VVUkwgPSBiYXNlVVJMO1xyXG4gICAgICB0aGlzLnhock1ldGhvZCA9IHhock1ldGhvZDtcclxuICAgICAgdGhpcy5jYkdldEV4dHJhUGFyYW1ldGVycyA9IGNiR2V0RXh0cmFQYXJhbWV0ZXJzO1xyXG4gICAgICAvKiogQHR5cGUge01hcDxzdHJpbmcsIEhUTUxBdWRpb0VsZW1lbnQ+fSAqL1xyXG4gICAgICB0aGlzLmF1ZGlvcyA9IG5ldyBNYXAoKTtcclxuICAgICAgdGhpcy5hdWRpb1NwZWVkID0gMS4wO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmdWxsVGV4dFxyXG4gICAgICogQHJldHVybnMge3N0cmluZ1tdfVxyXG4gICAgICovXHJcbiAgICBnZXRSZXF1ZXN0cyhmdWxsVGV4dCkge1xyXG4gICAgICAvKiogQHR5cGUge3N0cmluZ1tdfSAqL1xyXG4gICAgICBjb25zdCBmdWxsVGV4dFNwbGl0dGVkID0gW107XHJcbiAgICAgIGZ1bGxUZXh0XHJcbiAgICAgICAgLnRyaW0oKVxyXG4gICAgICAgIC5zcGxpdChcIiBcIilcclxuICAgICAgICAuZm9yRWFjaCgod29yZCkgPT4ge1xyXG4gICAgICAgICAgaWYgKHdvcmQubGVuZ3RoID4gMTYwKSB7XHJcbiAgICAgICAgICAgIHdoaWxlICh3b3JkLmxlbmd0aCA+IDE2MCkge1xyXG4gICAgICAgICAgICAgIGZ1bGxUZXh0U3BsaXR0ZWQucHVzaCh3b3JkLnNsaWNlKDAsIDE2MCkpO1xyXG4gICAgICAgICAgICAgIHdvcmQgPSB3b3JkLnNsaWNlKDE2MCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHdvcmQudHJpbSgpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICBmdWxsVGV4dFNwbGl0dGVkLnB1c2god29yZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSBpZiAod29yZC50cmltKCkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBmdWxsVGV4dFNwbGl0dGVkLnB1c2god29yZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAvKiogQHR5cGUge3N0cmluZ1tdfSAqL1xyXG4gICAgICBjb25zdCByZXF1ZXN0cyA9IFtdO1xyXG4gICAgICBsZXQgcmVxdWVzdFN0cmluZyA9IFwiXCI7XHJcbiAgICAgIGZvciAobGV0IHRleHQgb2YgZnVsbFRleHRTcGxpdHRlZCkge1xyXG4gICAgICAgIHRleHQgKz0gXCIgXCI7XHJcbiAgICAgICAgaWYgKHJlcXVlc3RTdHJpbmcubGVuZ3RoICsgdGV4dC5sZW5ndGggPCAxNzApIHtcclxuICAgICAgICAgIHJlcXVlc3RTdHJpbmcgKz0gdGV4dDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVxdWVzdHMucHVzaChyZXF1ZXN0U3RyaW5nKTtcclxuICAgICAgICAgIHJlcXVlc3RTdHJpbmcgPSB0ZXh0O1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBpZiAocmVxdWVzdFN0cmluZy50cmltKCkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHJlcXVlc3RzLnB1c2gocmVxdWVzdFN0cmluZyk7XHJcbiAgICAgICAgcmVxdWVzdFN0cmluZyA9IFwiXCI7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiByZXF1ZXN0cztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHRhcmdldExhbmd1YWdlXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxhbnk+fVxyXG4gICAgICovXHJcbiAgICBhc3luYyBtYWtlUmVxdWVzdCh0ZXh0LCB0YXJnZXRMYW5ndWFnZSkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgICAgIHhoci5vbmxvYWQgPSAoZSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgICAgICAgIHJlYWRlci5vbmxvYWRlbmQgPSAoKSA9PiByZXNvbHZlKHJlYWRlci5yZXN1bHQpO1xyXG4gICAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSAoKSA9PiByZWplY3QoKTtcclxuICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKHhoci5yZXNwb25zZSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB4aHIub25lcnJvciA9IChlKSA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgICAgICAgcmVqZWN0KCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB4aHIub3BlbihcclxuICAgICAgICAgIHRoaXMueGhyTWV0aG9kLFxyXG4gICAgICAgICAgdGhpcy5iYXNlVVJMICsgdGhpcy5jYkdldEV4dHJhUGFyYW1ldGVycyh0ZXh0LCB0YXJnZXRMYW5ndWFnZSlcclxuICAgICAgICApO1xyXG4gICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSBcImJsb2JcIjtcclxuICAgICAgICB4aHIuc2VuZCgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZnVsbFRleHRcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YXJnZXRMYW5ndWFnZVxyXG4gICAgICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XHJcbiAgICAgKi9cclxuICAgIGFzeW5jIHRleHRUb1NwZWVjaChmdWxsVGV4dCwgdGFyZ2V0TGFuZ3VhZ2UpIHtcclxuICAgICAgY29uc3QgcmVxdWVzdHMgPSB0aGlzLmdldFJlcXVlc3RzKGZ1bGxUZXh0KTtcclxuICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcclxuXHJcbiAgICAgIGZvciAoY29uc3QgcmVxdWVzdFRleHQgb2YgcmVxdWVzdHMpIHtcclxuICAgICAgICBjb25zdCBhdWRpb0tleSA9IFt0YXJnZXRMYW5ndWFnZSwgcmVxdWVzdFRleHRdLmpvaW4oXCIsIFwiKTtcclxuICAgICAgICBpZiAoIXRoaXMuYXVkaW9zLmdldChhdWRpb0tleSkpIHtcclxuICAgICAgICAgIHByb21pc2VzLnB1c2goXHJcbiAgICAgICAgICAgIHRoaXMubWFrZVJlcXVlc3QocmVxdWVzdFRleHQsIHRhcmdldExhbmd1YWdlKVxyXG4gICAgICAgICAgICAgIC50aGVuKFxyXG4gICAgICAgICAgICAgICAgLyoqIEB0eXBlIHtzdHJpbmd9ICovIChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICB0aGlzLmF1ZGlvcy5zZXQoYXVkaW9LZXksIG5ldyBBdWRpbyhyZXNwb25zZSkpO1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wbGF5KFxyXG4gICAgICAgIHJlcXVlc3RzLm1hcCgodGV4dCkgPT5cclxuICAgICAgICAgIHRoaXMuYXVkaW9zLmdldChbdGFyZ2V0TGFuZ3VhZ2UsIHRleHRdLmpvaW4oXCIsIFwiKSlcclxuICAgICAgICApXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcGFyYW0ge0hUTUxBdWRpb0VsZW1lbnQgfCBIVE1MQXVkaW9FbGVtZW50W119IGF1ZGlvc1xyXG4gICAgICovXHJcbiAgICBhc3luYyBwbGF5KGF1ZGlvcykge1xyXG4gICAgICB0aGlzLnN0b3BBbGwoKTtcclxuICAgICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGlmIChhdWRpb3MgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgICAgICBjb25zdCBwbGF5QWxsID0gKC8qKiBAdHlwZSB7bnVtYmVyfSAqLyBjdXJyZW50SW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLnN0b3BBbGwoKTtcclxuICAgICAgICAgICAgICBjb25zdCBhdWRpbyA9IGF1ZGlvc1tjdXJyZW50SW5kZXhdO1xyXG4gICAgICAgICAgICAgIGlmIChhdWRpbykge1xyXG4gICAgICAgICAgICAgICAgYXVkaW8ucGxheWJhY2tSYXRlID0gdGhpcy5hdWRpb1NwZWVkO1xyXG4gICAgICAgICAgICAgICAgYXVkaW8ucGxheSgpO1xyXG4gICAgICAgICAgICAgICAgYXVkaW8ub25lbmRlZCA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcGxheUFsbChjdXJyZW50SW5kZXggKyAxKTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHBsYXlBbGwoMCk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGF1ZGlvcyBpbnN0YW5jZW9mIEhUTUxBdWRpb0VsZW1lbnQpIHtcclxuICAgICAgICAgICAgYXVkaW9zLnBsYXliYWNrUmF0ZSA9IHRoaXMuYXVkaW9TcGVlZDtcclxuICAgICAgICAgICAgYXVkaW9zLnBsYXkoKTtcclxuICAgICAgICAgICAgYXVkaW9zLm9uZW5kZWQgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gc3BlZWRcclxuICAgICAqL1xyXG4gICAgc2V0QXVkaW9TcGVlZChzcGVlZCkge1xyXG4gICAgICB0aGlzLmF1ZGlvU3BlZWQgPSBzcGVlZDtcclxuICAgICAgdGhpcy5hdWRpb3MuZm9yRWFjaCgoYXVkaW8pID0+IHtcclxuICAgICAgICBhdWRpby5wbGF5YmFja1JhdGUgPSB0aGlzLmF1ZGlvU3BlZWQ7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHN0b3BBbGwoKSB7XHJcbiAgICAgIHRoaXMuYXVkaW9zLmZvckVhY2goKGF1ZGlvKSA9PiB7XHJcbiAgICAgICAgYXVkaW8ucGF1c2UoKTtcclxuICAgICAgICBhdWRpby5jdXJyZW50VGltZSA9IDA7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3QgZ29vZ2xlU2VydmljZSA9IG5ldyBTZXJ2aWNlKFxyXG4gICAgXCJnb29nbGVcIixcclxuICAgIFwiaHR0cHM6Ly90cmFuc2xhdGUuZ29vZ2xlLmNvbS90cmFuc2xhdGVfdHRzP2llPVVURi04XCIsXHJcbiAgICBcIkdFVFwiLFxyXG4gICAgZnVuY3Rpb24gZ2V0RXh0cmFQYXJhbWV0ZXJzKHRleHQsIHRhcmdldExhbmd1YWdlKSB7XHJcbiAgICAgIHJldHVybiBgJnRsPSR7dGFyZ2V0TGFuZ3VhZ2V9JmNsaWVudD1kaWN0LWNocm9tZS1leCZ0dHNzcGVlZD0wLjUmcT0ke2VuY29kZVVSSUNvbXBvbmVudChcclxuICAgICAgICB0ZXh0XHJcbiAgICAgICl9YDtcclxuICAgIH1cclxuICApO1xyXG5cclxuICBjaHJvbWUucnVudGltZS5vbk1lc3NhZ2UuYWRkTGlzdGVuZXIoKHJlcXVlc3QsIHNlbmRlciwgc2VuZFJlc3BvbnNlKSA9PiB7XHJcbiAgICBpZiAocmVxdWVzdC5hY3Rpb24gPT09IFwidGV4dFRvU3BlZWNoXCIpIHtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKChyZXF1ZXN0LCBzZW5kZXIsIHNlbmRSZXNwb25zZSkgPT4ge1xyXG4gICAgaWYgKHJlcXVlc3QuYWN0aW9uID09PSBcInRleHRUb1NwZWVjaFwiKSB7XHJcbiAgICAgIGdvb2dsZVNlcnZpY2VcclxuICAgICAgICAudGV4dFRvU3BlZWNoKHJlcXVlc3QudGV4dCwgcmVxdWVzdC50YXJnZXRMYW5ndWFnZSlcclxuICAgICAgICAuZmluYWxseSgoKSA9PiB7XHJcbiAgICAgICAgICBzZW5kUmVzcG9uc2UoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSBlbHNlIGlmIChyZXF1ZXN0LmFjdGlvbiA9PT0gXCJzdG9wQXVkaW9cIikge1xyXG4gICAgICBnb29nbGVTZXJ2aWNlLnN0b3BBbGwoKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgdHdwQ29uZmlnLm9uUmVhZHkoYXN5bmMgKCkgPT4ge1xyXG4gICAgdHdwQ29uZmlnLm9uQ2hhbmdlZCgobmFtZSwgbmV3dmFsdWUpID0+IHtcclxuICAgICAgaWYgKG5hbWUgPT09IFwidHRzU3BlZWRcIikge1xyXG4gICAgICAgIGdvb2dsZVNlcnZpY2Uuc2V0QXVkaW9TcGVlZChuZXd2YWx1ZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICB0ZXh0VG9TcGVlY2guZ29vZ2xlID0gZ29vZ2xlU2VydmljZTtcclxuXHJcbiAgcmV0dXJuIHRleHRUb1NwZWVjaDtcclxufSkoKTtcclxuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxZQUFZLEdBQUksWUFBWTtFQUNoQyxNQUFNQSxZQUFZLEdBQUcsRUFBckI7RUFFQTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0VBQ0UsTUFBTUMsT0FBTixDQUFjO0lBQ1o7QUFDSjtBQUNBO0FBQ0E7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
